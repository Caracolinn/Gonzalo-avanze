<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mantenedor de Calificaciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-responsive { max-height: 600px; }
        th { position: sticky; top: 0; background: #f8f9fa; }
        .fila-seleccionada { background-color: #cfe2ff !important; }
        tbody tr:hover { cursor: pointer; }
        .modal-body-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h2>Mantenedor de Calificaciones Tributarias</h2>
        
        <div id="alerta-contenedor">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <form method="get" action="{% url 'mantenedor' %}">
                    <div class="row g-3">
                        <div class="col-md-3">{{ form.tipo_mercado.label_tag }}{{ form.tipo_mercado }}</div>
                        <div class="col-md-3">{{ form.origen.label_tag }}{{ form.origen }}</div>
                        <div class="col-md-3">{{ form.periodo_comercial.label_tag }}{{ form.periodo_comercial }}</div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">Buscar</button>
                            <a href="{% url 'mantenedor' %}" class="btn btn-secondary">Limpiar</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered">
                        <thead>
                            <tr>
                                <th>Ejercicio</th>
                                <th>Instrumento</th>
                                <th>Fecha Pago</th>
                                <th>Descripción</th>
                                <th>Secuencia</th>
                                <th>Isfut/Isift</th>
                                <th>Origen</th>
                                <th>Factor Act.</th>
                                <th>F8 (Créd. DPC)</th>
                                <th>F9 (Créd. DPC Acum)</th>
                            </tr>
                        </thead>
                        <tbody id="grilla-calificaciones">
                            {% for cal in calificaciones %}
                            <tr data-id="{{ cal.id }}">
                                <td>{{ cal.fecha|date:"Y" }}</td>
                                <td>{{ cal.instrumento }}</td>
                                <td>{{ cal.fecha }}</td>
                                <td>{{ cal.descripcion_dividendo|default_if_none:"" }}</td>
                                <td>{{ cal.secuencia }}</td>
                                <td>{% if cal.acogido_isfut %}Sí{% else %}No{% endif %}</td>
                                <td>{{ cal.get_origen_display }}</td>
                                <td>{{ cal.factor_actualizacion }}</td>
                                <td>{{ cal.factor_8 }}</td>
                                <td>{{ cal.factor_9 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center">No se encontraron registros.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <button id="btnEliminar" class="btn btn-danger" disabled>Eliminar</button>
            <a href="{% url 'carga_masiva_factores' %}" class="btn btn-success">Carga Masiva (Factores)</a>
            <a href="{% url 'carga_masiva_montos' %}" class="btn btn-success">Carga Masiva (Montos)</a>
            <button id="btnIngresar" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ingresoModalPaso1">
                Ingresar
            </button>
            <button id="btnModificar" class="btn btn-warning" disabled>Modificar</button>
        </div>
    </div>

    <div class="modal fade" id="ingresoModalPaso1" tabindex="-1" aria-labelledby="ingresoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ingresoModalLabel">Ingresar Nueva Calificación (Paso 1 de 3)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formIngresoBasico">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div id="erroresPaso1" class="alert alert-danger" style="display: none;"></div>
                        <div class="row g-3">
                            <div class="col-md-6">{{ ingreso_form.tipo_mercado.label_tag }}{{ ingreso_form.tipo_mercado }}</div>
                            <div class="col-md-6">{{ ingreso_form.instrumento.label_tag }}{{ ingreso_form.instrumento }}</div>
                            <div class="col-md-6">{{ ingreso_form.secuencia.label_tag }}{{ ingreso_form.secuencia }}</div>
                            <div class="col-md-6">{{ ingreso_form.numero_dividendo.label_tag }}{{ ingreso_form.numero_dividendo }}</div>
                            <div class="col-md-6">{{ ingreso_form.fecha.label_tag }}{{ ingreso_form.fecha }}</div>
                            <div class="col-md-6">{{ ingreso_form.valor_historico.label_tag }}{{ ingreso_form.valor_historico }}</div>
                            <div class="col-md-6">{{ ingreso_form.periodo.label_tag }}{{ ingreso_form.periodo }}</div>
                            <div class="col-md-6">{{ ingreso_form.factor_actualizacion.label_tag }}{{ ingreso_form.factor_actualizacion }}</div>
                            <div class="col-12">{{ ingreso_form.descripcion_dividendo.label_tag }}{{ ingreso_form.descripcion_dividendo }}</div>
                            <div class="col-12"><div class="form-check">{{ ingreso_form.acogido_isfut }} {{ ingreso_form.acogido_isfut.label_tag }}</div></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">OK (Siguiente a Montos)</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="ingresoModalPaso2" tabindex="-1" aria-labelledby="ingresoModalPaso2Label" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ingresoModalPaso2Label">Ingresar Montos (Paso 2 de 3)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formIngresoMontos" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>Ingrese los montos para calcular los factores.</p>
                        <div id="erroresPaso2" class="alert alert-danger" style="display: none;"></div>
                        <div class="modal-body-grid">
                            {% for field in montos_form %}
                                <div>
                                    {{ field.label_tag }}
                                    {{ field }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Calcular y Siguiente (Paso 3)</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="ingresoModalPaso3" tabindex="-1" aria-labelledby="ingresoModalPaso3Label" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ingresoModalPaso3Label">Revisar Factores Calculados (Paso 3 de 3)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formIngresoFactores" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>Revise los factores calculados. Puede editarlos antes de guardar.</p>
                        <div id="erroresPaso3" class="alert alert-danger" style="display: none;"></div>
                        <div class="modal-body-grid">
                            {% for field in factores_form %}
                                <div>
                                    {{ field.label_tag }}
                                    {{ field }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Grabar Calificación</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function mostrarAlerta(mensaje, tipo) {
            $('#alerta-contenedor').html(
                `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`
            );
        }

        $(document).ready(function() {
            var modalPaso1 = new bootstrap.Modal(document.getElementById('ingresoModalPaso1'));
            var modalPaso2 = new bootstrap.Modal(document.getElementById('ingresoModalPaso2'));
            var modalPaso3 = new bootstrap.Modal(document.getElementById('ingresoModalPaso3')); // <-- NUEVA MODAL
            var idSeleccionado = null;
            var esModificacion = false;

            // --- Lógica de SELECCIÓN DE FILA ---
            $("#grilla-calificaciones tr").on("click", function() {
                $(this).siblings().removeClass("fila-seleccionada");
                $(this).toggleClass("fila-seleccionada");
                if ($(this).hasClass("fila-seleccionada")) {
                    idSeleccionado = $(this).data("id");
                    $("#btnEliminar").prop("disabled", false);
                    $("#btnModificar").prop("disabled", false);
                } else {
                    idSeleccionado = null;
                    $("#btnEliminar").prop("disabled", true);
                    $("#btnModificar").prop("disabled", true);
                }
            });

            // --- Lógica del botón INGRESAR ---
            $("#btnIngresar").on("click", function() {
                esModificacion = false;
                $("#formIngresoBasico")[0].reset();
                $("#ingresoModalLabel").text("Ingresar Nueva Calificación (Paso 1 de 3)");
                $("#formIngresoBasico").attr('action', "{% url 'ingresar_calificacion' %}");
                $("#formIngresoBasico").attr('method', 'post');
                $("#erroresPaso1").hide();
            });
            
            // --- Lógica del botón MODIFICAR ---
            $("#btnModificar").on("click", function() {
                if (idSeleccionado) {
                    esModificacion = true;
                    $.ajax({
                        type: "GET",
                        url: `/calificaciones/obtener/${idSeleccionado}/`,
                        dataType: 'json',
                        success: function(response) {
                            if (response.success) {
                                let data = response.data;
                                let form = $("#formIngresoBasico");
                                form.find('[name="tipo_mercado"]').val(data.tipo_mercado);
                                form.find('[name="instrumento"]').val(data.instrumento);
                                form.find('[name="secuencia"]').val(data.secuencia);
                                form.find('[name="numero_dividendo"]').val(data.numero_dividendo);
                                form.find('[name="fecha"]').val(data.fecha);
                                form.find('[name="valor_historico"]').val(data.valor_historico);
                                form.find('[name="periodo"]').val(data.fecha.substring(0, 4));
                                form.find('[name="factor_actualizacion"]').val(data.factor_actualizacion);
                                form.find('[name="descripcion_dividendo"]').val(data.descripcion_dividendo);
                                form.find('[name="acogido_isfut"]').prop('checked', data.acogido_isfut);
                                
                                $("#ingresoModalLabel").text("Modificar Calificación (Paso 1 de 3)");
                                $("#formIngresoBasico").attr('action', `/calificaciones/modificar/${idSeleccionado}/`);
                                $("#formIngresoBasico").attr('method', 'post');
                                $("#erroresPaso1").hide();
                                modalPaso1.show();
                            } else { mostrarAlerta("Error al cargar datos: " + response.message, 'danger'); }
                        },
                        error: function() { mostrarAlerta("Error de conexión al cargar datos.", 'danger'); }
                    });
                }
            });

            // --- Lógica del formulario PASO 1 (Ingresar O Modificar) ---
            $("#formIngresoBasico").on("submit", function(e) {
                e.preventDefault(); 
                var form = $(this);
                $.ajax({
                    type: form.attr('method'), 
                    url: form.attr('action'),
                    data: form.serialize(),
                    dataType: 'json',
                    headers: { "X-CSRFToken": csrftoken },
                    success: function(response) {
                        if (response.success) {
                            modalPaso1.hide();
                            var calificacionId = response.calificacion_id;
                            
                            // Preparamos la Modal 2
                            var urlPaso2 = `/calificaciones/ingresar-montos/${calificacionId}/`;
                            $("#formIngresoMontos").attr('action', urlPaso2);
                            $("#formIngresoMontos")[0].reset();
                            $("#erroresPaso2").hide();
                            
                            // Preparamos la Modal 3
                            var urlPaso3 = `/calificaciones/guardar-factores/${calificacionId}/`;
                            $("#formIngresoFactores").attr('action', urlPaso3);
                            $("#formIngresoFactores")[0].reset();
                            $("#erroresPaso3").hide();

                            modalPaso2.show();
                        } else {
                            $("#erroresPaso1").html("Error: " + response.errors).show();
                        }
                    },
                    error: function() { $("#erroresPaso1").html("Error de conexión.").show(); }
                });
            });

            // --- Lógica del formulario PASO 2 (Montos) ---
            $("#formIngresoMontos").on("submit", function(e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    type: form.attr('method'),
                    url: form.attr('action'),
                    data: form.serialize(),
                    dataType: 'json',
                    headers: { "X-CSRFToken": csrftoken },
                    success: function(response) {
                        if (response.success) {
                            // ¡ÉXITO! Ahora poblamos la Modal 3 con los factores
                            modalPaso2.hide();
                            
                            // Rellenamos el formulario de factores (Paso 3)
                            let factores = response.factores;
                            let formPaso3 = $("#formIngresoFactores");
                            for (let i = 8; i < 38; i++) {
                                let key = `factor_${i}`;
                                formPaso3.find(`[name="${key}"]`).val(factores[key]);
                            }

                            // Mostramos la Modal 3
                            modalPaso3.show();
                        } else {
                            $("#erroresPaso2").html("Error: " + response.errors).show();
                        }
                    },
                    error: function() { $("#erroresPaso2").html("Error de conexión.").show(); }
                });
            });

            // --- ¡NUEVA! Lógica del formulario PASO 3 (Factores) ---
            $("#formIngresoFactores").on("submit", function(e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    type: form.attr('method'),
                    url: form.attr('action'),
                    data: form.serialize(),
                    dataType: 'json',
                    headers: { "X-CSRFToken": csrftoken },
                    success: function(response) {
                        if (response.success) {
                            // ¡TERMINADO! Cerramos la modal y recargamos
                            modalPaso3.hide();
                            var mensaje = esModificacion ? "Calificación modificada exitosamente." : "Calificación ingresada exitosamente.";
                            mostrarAlerta(mensaje, "success");
                            setTimeout(function() { location.reload(); }, 1500);
                        } else {
                            // Mostramos el error de validación (ej. suma > 1)
                            $("#erroresPaso3").html("Error: " + response.errors).show();
                        }
                    },
                    error: function() { $("#erroresPaso3").html("Error de conexión.").show(); }
                });
            });

            // --- Lógica para ELIMINAR ---
            $("#btnEliminar").on("click", function() {
                if (idSeleccionado && confirm("¿Estás seguro de que deseas eliminar este registro?")) {
                    $.ajax({
                        type: "POST",
                        url: `/calificaciones/eliminar/${idSeleccionado}/`,
                        headers: { "X-CSRFToken": csrftoken },
                        dataType: 'json',
                        success: function(response) {
                            if (response.success) {
                                $(`tr[data-id="${idSeleccionado}"]`).remove();
                                mostrarAlerta(response.message, 'success');
                                idSeleccionado = null;
                                $("#btnEliminar").prop("disabled", true);
                                $("#btnModificar").prop("disabled", true);
                            } else {
                                mostrarAlerta('Error: ' + response.message, 'danger');
                            }
                        },
                        error: function() {
                            mostrarAlerta("Error de conexión. No se pudo eliminar.", 'danger');
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>